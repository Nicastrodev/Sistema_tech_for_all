<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Criar ou Editar Turma - Tech For All</title>
    <link rel="stylesheet" href="/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <header class="header">
      <div class="header-container">
        <div class="brand">
          <div class="logo">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
              <path
                d="M16 2L28 9V23L16 30L4 23V9L16 2Z"
                fill="white"
                opacity="0.2"
              />
              <path
                d="M16 8L22 11.5V18.5L16 22L10 18.5V11.5L16 8Z"
                fill="white"
              />
            </svg>
          </div>
          <div class="brand-text">
            <h1>Tech For All</h1>
            <p>Inclus√£o Digital com Seguran√ßa</p>
          </div>
        </div>

        <div class="header-actions">
          <div class="role-badge">Professor</div>
          <button class="btn-secondary" onclick="logout()">Sair</button>
        </div>
      </div>
    </header>

    <main class="main-container">
      <section class="screen">
        <div class="form-container">
          <div class="card">
            <div class="card-header">
              <h3 id="formTitle">Criar Nova Turma</h3>
              <p id="formSubtitle">Preencha os dados da turma</p>
            </div>

            <form id="createClassForm" class="form">
              <div class="form-group">
                <label for="className">Nome da turma</label>
                <input
                  type="text"
                  id="className"
                  placeholder="Ex: 7¬∫ A"
                  required
                />
              </div>

              <div class="form-group">
                <label for="classDesc">Descri√ß√£o</label>
                <textarea
                  id="classDesc"
                  rows="3"
                  placeholder="Descri√ß√£o breve da turma"
                ></textarea>
              </div>

              <div id="codeDisplay" class="form-group" style="display: none">
                <label>C√≥digo de acesso:</label>
                <p
                  id="classCodeDisplay"
                  style="font-weight: bold; color: #2e86c1"
                ></p>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn-primary" id="submitBtn">
                  Criar Turma
                </button>
                <button
                  type="button"
                  class="btn-outline"
                  onclick="window.location.href='/dashboard/teacher'"
                >
                  Cancelar
                </button>
              </div>
            </form>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <p>&copy; 2025 Tech For All | Prot√≥tipo Acad√™mico</p>
    </footer>

    <script src="/common.js"></script>
    <script>
      const API_BASE_URL =
        window.API_BASE_URL || `${window.location.origin}/api`;

      /* ==========================
         MODAL ESTILIZADO (TOAST)
      =========================== */
      function showModal({ title = "Aviso", message = "", okText = "OK" }) {
        let modal = document.getElementById("tfa-modal");
        if (!modal) {
          modal = document.createElement("div");
          modal.id = "tfa-modal";
          modal.innerHTML = `
            <style>
              .tfa-overlay {
                position: fixed; inset: 0;
                background: rgba(0,0,0,0.4);
                display: flex; align-items: center; justify-content: center;
                z-index: 9999;
              }
              .tfa-box {
                background: #fff;
                border-radius: 12px;
                padding: 24px;
                width: 90%;
                max-width: 420px;
                text-align: center;
                font-family: Inter, sans-serif;
                box-shadow: 0 10px 25px rgba(0,0,0,0.15);
                animation: fadeIn 0.3s ease;
              }
              .tfa-box h3 { color: #2E86C1; margin-bottom: 10px; }
              .tfa-box p { color: #333; margin-bottom: 20px; white-space: pre-line; }
              .tfa-box button {
                background: #2E86C1; color: white;
                border: none; border-radius: 8px;
                padding: 8px 16px; cursor: pointer; font-weight: 600;
              }
              .tfa-box button:hover { background: #216499; }
              @keyframes fadeIn { from { opacity: 0; transform: scale(0.9);} to { opacity: 1; transform: scale(1);} }
            </style>
            <div class="tfa-overlay">
              <div class="tfa-box">
                <h3 id="tfa-title"></h3>
                <p id="tfa-msg"></p>
                <button id="tfa-ok">${okText}</button>
              </div>
            </div>`;
          document.body.appendChild(modal);
        }

        modal.querySelector("#tfa-title").textContent = title;
        modal.querySelector("#tfa-msg").innerHTML = message;
        modal.style.display = "flex";
        modal.querySelector("#tfa-ok").onclick = () =>
          (modal.style.display = "none");
      }

      /* ==========================
         L√ìGICA PRINCIPAL
      =========================== */
      document.addEventListener("DOMContentLoaded", async () => {
        const user_id = localStorage.getItem("tf_user_id");
        const role = localStorage.getItem("tf_role");
        const turmaId = new URLSearchParams(window.location.search).get("id");
        const form = document.getElementById("createClassForm");

        if (!user_id || role !== "teacher") {
          showModal({
            title: "Acesso negado",
            message:
              "Voc√™ precisa estar logado como professor para criar ou editar turmas.",
          });
          return;
        }

        // ===== EDI√á√ÉO DE TURMA =====
        if (turmaId) {
          document.getElementById("formTitle").textContent = "Editar Turma";
          document.getElementById("formSubtitle").textContent =
            "Altere os dados e salve as mudan√ßas";
          document.getElementById("submitBtn").textContent =
            "Salvar Altera√ß√µes";

          try {
            const res = await fetch(`${API_BASE_URL}/turmas/${turmaId}`);
            const data = await res.json();

            if (data.success && data.turma) {
              const turma = data.turma;
              document.getElementById("className").value = turma.nome || "";
              document.getElementById("classDesc").value =
                turma.descricao || "";
              if (turma.codigo_acesso) {
                document.getElementById("classCodeDisplay").textContent =
                  turma.codigo_acesso;
                document.getElementById("codeDisplay").style.display = "block";
              }
            } else {
              showModal({
                title: "Erro",
                message:
                  data.message ||
                  "N√£o foi poss√≠vel carregar os dados da turma.",
              });
            }
          } catch (e) {
            console.error("Erro ao carregar turma:", e);
            showModal({
              title: "Erro",
              message: "Falha ao conectar com o servidor.",
            });
          }
        }

        // ===== SALVAR / ATUALIZAR =====
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const nome = document.getElementById("className").value.trim();
          const descricao = document.getElementById("classDesc").value.trim();

          if (!nome)
            return showModal({
              title: "Campo obrigat√≥rio",
              message: "Por favor, insira o nome da turma.",
            });

          const method = turmaId ? "PUT" : "POST";
          const endpoint = turmaId
            ? `${API_BASE_URL}/turmas/${turmaId}`
            : `${API_BASE_URL}/turmas`;

          try {
            const res = await fetch(endpoint, {
              method,
              headers: {
                "Content-Type": "application/json",
                "X-User-Id": user_id,
                "X-User-Role": role,
              },
              body: JSON.stringify({ nome, descricao }),
            });

            const data = await res.json();

            if (data.success) {
              const msg = turmaId
                ? "Turma atualizada com sucesso!"
                : `Turma "${nome}" criada!\n\nC√≥digo: ${
                    data.codigo_acesso || "(gerado automaticamente)"
                  }`;
              showModal({ title: "Sucesso üéâ", message: msg });

              setTimeout(
                () => (window.location.href = "/dashboard/teacher"),
                2000
              );
            } else {
              showModal({
                title: "Erro",
                message:
                  data.message ||
                  "N√£o foi poss√≠vel salvar a turma. Tente novamente.",
              });
            }
          } catch (err) {
            console.error("Erro ao salvar turma:", err);
            showModal({
              title: "Erro de conex√£o",
              message: "N√£o foi poss√≠vel conectar ao servidor.",
            });
          }
        });
      });
    </script>
  </body>
</html>
