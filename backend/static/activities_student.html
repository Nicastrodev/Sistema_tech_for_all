<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Minhas Atividades - Tech For All</title>
    <link rel="stylesheet" href="/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg: #f7f8fb;
        --card: #ffffff;
        --muted: #6b7280;
        --text: #111827;
        --accent: #5b6cff;
        --success: #16a34a;
        --danger: #ef4444;
        --surface: #f3f4f6;
      }

      html,
      body {
        height: 100%;
      }
      body {
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji",
          "Segoe UI Emoji";
        background-color: var(--bg);
        margin: 0;
        color: var(--text);
      }

      header.header {
        background: white;
        border-bottom: 1px solid #eef0f4;
        padding: 14px 28px;
        position: sticky;
        top: 0;
        z-index: 20;
      }
      .header-container {
        max-width: 1120px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .brand-text h1 {
        font-size: 18px;
        margin: 0;
      }
      .brand-text p {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
      }

      .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .role-badge {
        background: linear-gradient(180deg, #ffefcc, #fff);
        padding: 8px 12px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 13px;
        color: #a05200;
      }

      main {
        max-width: 1120px;
        margin: 28px auto;
        padding: 0 20px 60px 20px;
      }

      .card {
        background: var(--card);
        border-radius: 14px;
        box-shadow: 0 6px 20px rgba(14, 20, 30, 0.06);
        padding: 28px;
      }

      .page-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 20px;
        margin-bottom: 18px;
      }
      .page-header h3 {
        margin: 0;
        font-size: 1.5rem;
      }
      .page-header p {
        margin: 6px 0 0 0;
        color: var(--muted);
      }

      /* Activity list (vertical cards) */
      .activity-list {
        display: flex;
        flex-direction: column;
        gap: 18px;
        margin-top: 12px;
      }

      .activity-item {
        background: linear-gradient(180deg, var(--card), #fcfdff);
        border: 1px solid #e8edf8;
        border-radius: 12px;
        padding: 18px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .activity-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }

      .activity-info {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .activity-title {
        font-size: 1.12rem;
        font-weight: 700;
        margin: 0;
        color: var(--text);
      }

      .meta-row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      .activity-due {
        font-size: 13px;
        color: var(--muted);
        background: #fff9eb;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #fff0c7;
        font-weight: 600;
      }

      .activity-class {
        font-size: 13px;
        color: #334155;
        background: #f5f8ff;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #e6eefc;
      }

      .activity-desc {
        color: #374151;
        line-height: 1.6;
        margin: 0;
        font-size: 15px;
      }

      .activity-files {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 6px;
      }
      .activity-files a {
        text-decoration: none;
        color: var(--accent);
        font-weight: 600;
        background: #f2f6ff;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #e7efff;
      }

      .activity-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        justify-content: space-between;
        margin-top: 8px;
        flex-wrap: wrap;
      }

      .upload-area {
        display: flex;
        gap: 8px;
        align-items: center;
        flex: 1;
      }
      .file-input {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        background: #fff;
        flex: 1;
        min-width: 220px;
      }

      .btn {
        border: none;
        border-radius: 10px;
        padding: 10px 14px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
      }
      .btn-primary {
        background: var(--accent);
        color: white;
      }
      .btn-primary:hover {
        filter: brightness(0.95);
      }
      .btn-ghost {
        background: transparent;
        color: var(--accent);
        border: 1px solid #e7eeff;
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        padding: 8px 10px;
        border-radius: 999px;
      }
      .status-pending {
        background: var(--surface);
        color: #555;
      }
      .status-done {
        background: #ecfdf5;
        color: var(--success);
        border: 1px solid rgba(16, 185, 129, 0.12);
      }

      /* small helper */
      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      /* responsive */
      @media (max-width: 880px) {
        .activity-top {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        .activity-actions {
          flex-direction: column;
          align-items: stretch;
        }
        .upload-area {
          width: 100%;
        }
        .file-input {
          width: 100%;
        }
        .btn {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <header class="header">
      <div class="header-container">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <svg width="36" height="36" viewBox="0 0 32 32" fill="none">
              <path
                d="M16 2L28 9V23L16 30L4 23V9L16 2Z"
                fill="#5b6cff"
                opacity="0.12"
              />
              <path
                d="M16 8L22 11.5V18.5L16 22L10 18.5V11.5L16 8Z"
                fill="#5b6cff"
              />
            </svg>
          </div>
          <div class="brand-text">
            <h1>Tech For All</h1>
            <p>Inclus√£o Digital com Seguran√ßa</p>
          </div>
        </div>

        <div class="header-actions">
          <div class="role-badge" id="currentRole">Aluno</div>
          <button class="btn btn-ghost" onclick="logout()">Sair</button>
        </div>
      </div>
    </header>

    <main>
      <div class="card" role="main" aria-labelledby="pageTitle">
        <div class="page-header">
          <div>
            <h3 id="pageTitle">Minhas Atividades</h3>
            <p class="muted">Visualize, envie e acompanhe suas atividades</p>
          </div>
          <div class="muted" id="infoBox" aria-hidden="true">
            <!-- espa√ßo para info r√°pida -->
          </div>
        </div>

        <div id="activityList" class="activity-list" aria-live="polite">
          <p class="muted">Carregando atividades...</p>
        </div>
      </div>
    </main>

    <footer
      class="footer"
      style="max-width: 1120px; margin: 28px auto 60px; padding: 0 20px"
    >
      <p style="color: var(--muted); font-size: 13px">
        &copy; 2025 Tech For All - Inclus√£o Digital com Seguran√ßa | Prot√≥tipo
        Acad√™mico
      </p>
    </footer>

    <script src="/common.js"></script>
    <script>
      const API_BASE = window.location.origin + "/api";

      function getSession() {
        return {
          user_id: localStorage.getItem("tf_user_id"),
          role: localStorage.getItem("tf_role"),
          name: localStorage.getItem("tf_name"),
        };
      }

      function notify(msg, type = "info") {
        if (typeof showToast === "function") showToast(msg, type);
        else alert(msg);
      }

      /* Renderiza a lista de atividades em cart√µes verticais.
         Mantive as chamadas e endpoints exatamente como antes. */
      async function loadActivities() {
        const list = document.getElementById("activityList");
        const s = getSession();

        if (!s.user_id || s.role !== "student") {
          list.innerHTML =
            "<p class='muted'>Erro: sess√£o inv√°lida. Fa√ßa login novamente.</p>";
          return;
        }

        try {
          const res = await fetch(
            `${API_BASE}/tarefas/listar?userId=${s.user_id}&role=${s.role}`,
            {
              headers: {
                "X-User-Id": s.user_id,
                "X-User-Role": s.role,
              },
            }
          );

          const data = await res.json();
          if (!res.ok || !data.success)
            throw new Error(data.message || "Erro ao carregar.");

          if (!data.tarefas || data.tarefas.length === 0) {
            list.innerHTML =
              "<p class='muted'>Nenhuma atividade dispon√≠vel.</p>";
            return;
          }

          list.innerHTML = "";
          data.tarefas.forEach((t) => {
            const prazo = t.prazo
              ? new Date(t.prazo).toLocaleDateString("pt-BR")
              : "Sem prazo";
            const entregue = !!t.entregue;
            const dataEnvio = t.data_envio
              ? new Date(t.data_envio).toLocaleString("pt-BR")
              : null;

            const item = document.createElement("article");
            item.className = "activity-item";
            item.setAttribute("data-tarefa-id", t.id);
            item.setAttribute("aria-labelledby", `title-${t.id}`);

            // anexos
            let anexos = "";
            if (t.arquivo) {
              const url = `${API_BASE}/uploads/${encodeURIComponent(
                t.arquivo
              )}`;
              anexos += `<a href="${url}" target="_blank" rel="noopener">üìé Arquivo</a>`;
            }
            if (t.link) {
              anexos += `<a href="${t.link}" target="_blank" rel="noopener">üåê Link</a>`;
            }

            const statusHTML = entregue
              ? `<span class="status-pill status-done">‚úÖ Entregue${
                  dataEnvio ? " ‚Äî " + dataEnvio : ""
                }</span>`
              : `<span class="status-pill status-pending">‚è≥ Pendente</span>`;

            item.innerHTML = `
              <div class="activity-top">
                <div class="activity-info">
                  <h4 id="title-${t.id}" class="activity-title">${escapeHtml(
              t.titulo
            )}</h4>
                  <div class="meta-row">
                    <span class="activity-due">Prazo: ${prazo}</span>
                    <span class="activity-class">${escapeHtml(
                      t.turma_nome || "Turma"
                    )}</span>
                    <span class="muted">‚Ä¢ ${
                      t.entregue ? "J√° enviado" : "Aguardando envio"
                    }</span>
                  </div>
                </div>
                <div class="meta-row">
                  ${statusHTML}
                </div>
              </div>

              <p class="activity-desc">${escapeHtml(
                t.descricao || "Sem descri√ß√£o."
              )}</p>

              <div class="activity-files">${anexos}</div>

              <div class="activity-actions">
                <div class="upload-area">
                  <input type="file" id="uploadFile-${
                    t.id
                  }" class="file-input" aria-label="Arquivo para ${escapeHtml(
              t.titulo
            )}" />
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                  <button class="btn btn-primary" onclick="sendActivity(${
                    t.id
                  })">Enviar Resposta</button>
                </div>
              </div>
            `;
            list.appendChild(item);
          });
        } catch (err) {
          console.error(err);
          list.innerHTML = `<p class="muted">Erro ao carregar atividades: ${escapeHtml(
            err.message || String(err)
          )}</p>`;
        }
      }

      async function sendActivity(tarefaId) {
        const s = getSession();
        const fileInput = document.getElementById(`uploadFile-${tarefaId}`);

        if (!fileInput || !fileInput.files.length) {
          return notify("Selecione um arquivo antes de enviar.", "error");
        }

        const form = new FormData();
        form.append("arquivo", fileInput.files[0]);

        try {
          const res = await fetch(`${API_BASE}/tarefas/${tarefaId}/responder`, {
            method: "POST",
            headers: {
              "X-User-Id": s.user_id,
              "X-User-Role": s.role,
            },
            body: form,
          });

          const data = await res.json();
          if (!data.success)
            throw new Error(data.message || "Falha ao enviar.");

          notify("Atividade enviada com sucesso!", "success");
          await loadActivities();
        } catch (err) {
          console.error(err);
          notify("Erro ao enviar: " + (err.message || err), "error");
        }
      }

      function openActivity(tarefaId) {
        // possibilidade de abrir p√°gina de detalhes no futuro
        // por enquanto redireciona para a turma onde est√° a atividade (se soubermos)
        // mantenho comportamento simples: grava last_tarefa e vai para /activities_student para futura navega√ß√£o
        localStorage.setItem("last_tarefa_id", tarefaId);
        notify("Abrindo detalhes (em breve)", "info");
      }

      // Helpers de escape (evita XSS)
      function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return "";
        return String(unsafe)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      document.addEventListener("DOMContentLoaded", () => {
        // atualiza badge de papel e nome (se dispon√≠vel)
        const s = getSession();
        if (s && s.role) {
          const badge = document.getElementById("currentRole");
          if (badge)
            badge.textContent = s.role === "student" ? "Aluno" : s.role;
        }
        loadActivities();
      });
    </script>
  </body>
</html>
