<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diário de Aula - Tech For All</title>
    <link rel="stylesheet" href="/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- HEADER -->
    <header class="header">
      <div class="header-container">
        <div class="brand">
          <div class="logo">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
              <path
                d="M16 2L28 9V23L16 30L4 23V9L16 2Z"
                fill="white"
                opacity="0.2"
              />
              <path
                d="M16 8L22 11.5V18.5L16 22L10 18.5V11.5L16 8Z"
                fill="white"
              />
            </svg>
          </div>
          <div class="brand-text">
            <h1>Tech For All</h1>
            <p>Inclusão Digital com Segurança</p>
          </div>
        </div>
        <div class="header-actions">
          <div class="role-badge" id="roleBadge">Professor</div>
          <button class="btn-secondary" onclick="logout()">Sair</button>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="main-container">
      <section class="screen">
        <div class="form-container">
          <div class="card">
            <div class="card-header">
              <h3>Diário de Aula</h3>
              <p>Registre o conteúdo da aula</p>
            </div>
            <form class="form" onsubmit="saveDiary(event)">
              <div class="form-group">
                <label for="diaryClass">Turma</label>
                <select id="diaryClass" required>
                  <option value="">Carregando turmas...</option>
                </select>
              </div>
              <div class="form-group">
                <label for="diaryDate">Data</label>
                <input type="date" id="diaryDate" required />
              </div>
              <div class="form-group">
                <label for="diaryContent">Conteúdo da aula</label>
                <textarea
                  id="diaryContent"
                  rows="6"
                  placeholder="Descreva o conteúdo abordado na aula"
                  required
                ></textarea>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn-primary">Gerar PDF</button>
              </div>
              <div id="diaryMsg" class="success-message"></div>
            </form>
          </div>
        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer class="footer">
      <p>
        &copy; 2025 Tech For All - Inclusão Digital com Segurança | Protótipo
        Acadêmico
      </p>
    </footer>

    <script src="/common.js"></script>
    <script>
      const API_BASE_URL =
        window.API_BASE_URL || `${window.location.origin}/api`;

      // ===============================
      // CARREGAR TURMAS REAIS
      // ===============================
      async function loadTeacherClasses() {
        const s = getSession();
        const select = document.getElementById("diaryClass");
        if (!s || s.role !== "teacher") {
          showToast("Acesso restrito a professores.", "error");
          window.location.href = "/";
          return;
        }

        try {
          const res = await fetch(
            `${API_BASE_URL}/turmas?userId=${s.user_id}&role=${s.role}`
          );
          const data = await res.json();

          select.innerHTML = "";
          if (!data.success || !data.turmas || data.turmas.length === 0) {
            select.innerHTML =
              "<option value=''>Nenhuma turma encontrada</option>";
            return;
          }

          data.turmas.forEach((t) => {
            const option = document.createElement("option");
            option.value = t.nome;
            option.textContent = `${t.nome} (${t.codigo_acesso})`;
            select.appendChild(option);
          });
        } catch (err) {
          console.error("Erro ao carregar turmas:", err);
          select.innerHTML =
            "<option value=''>Erro ao carregar turmas</option>";
        }
      }

      // ===============================
      // SALVAR E GERAR PDF
      // ===============================
      function saveDiary(event) {
        event.preventDefault();
        const turma = document.getElementById("diaryClass").value;
        const data = document.getElementById("diaryDate").value;
        const conteudo = document.getElementById("diaryContent").value;
        const s = getSession();

        if (!turma || !data || !conteudo) {
          showToast("Preencha todos os campos.", "error");
          return;
        }

        generateDiaryPDF(s.name, turma, data, conteudo);
        showToast("PDF gerado e baixado automaticamente!", "success");

        document.getElementById("diaryContent").value = "";
      }

      // ===============================
      // GERAR E BAIXAR PDF AUTOMATICAMENTE
      // ===============================
      function generateDiaryPDF(professor, turma, data, conteudo) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("Diário de Aula - Tech For All", 105, 20, { align: "center" });

        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        doc.text(`Professor: ${professor}`, 20, 40);
        doc.text(`Turma: ${turma}`, 20, 50);
        doc.text(`Data: ${new Date(data).toLocaleDateString("pt-BR")}`, 20, 60);

        doc.setFont("helvetica", "bold");
        doc.text("Conteúdo da Aula:", 20, 80);
        doc.setFont("helvetica", "normal");
        const textLines = doc.splitTextToSize(conteudo, 170);
        doc.text(textLines, 20, 90);

        doc.save(`diario_${turma}_${data}.pdf`);
      }

      // ===============================
      // INICIALIZAÇÃO
      // ===============================
      document.addEventListener("DOMContentLoaded", () => {
        loadTeacherClasses();

        const diaryDateInput = document.getElementById("diaryDate");
        if (diaryDateInput) {
          const today = new Date().toISOString().split("T")[0];
          diaryDateInput.value = today;
        }
      });
    </script>

    <!-- Biblioteca PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </body>
</html>
