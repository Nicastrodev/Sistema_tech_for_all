<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relatórios - Tech For All</title>
    <link rel="stylesheet" href="/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f9fafb;
        margin: 0;
      }

      main {
        display: flex;
        justify-content: center;
        padding: 50px 20px;
      }

      .card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        padding: 32px;
        width: 100%;
        max-width: 500px;
        text-align: center;
      }

      .card h2 {
        margin-top: 0;
      }

      label {
        font-weight: 600;
        display: block;
        margin: 20px 0 10px;
        text-align: left;
      }

      select {
        width: 100%;
        padding: 10px 12px;
        font-size: 1rem;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        outline: none;
        transition: border-color 0.2s;
      }

      select:focus {
        border-color: #6366f1;
      }

      button {
        margin-top: 24px;
        padding: 10px 16px;
        font-size: 1rem;
        border: none;
        border-radius: 8px;
        background: #4f46e5;
        color: white;
        cursor: pointer;
        transition: background 0.2s;
      }

      button:hover {
        background: #4338ca;
      }

      .muted {
        color: #6b7280;
        font-size: 14px;
        margin-top: 10px;
      }

      @media (max-width: 600px) {
        .card {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-container">
        <div class="brand">
          <div class="logo">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
              <path
                d="M16 2L28 9V23L16 30L4 23V9L16 2Z"
                fill="white"
                opacity="0.2"
              />
              <path
                d="M16 8L22 11.5V18.5L16 22L10 18.5V11.5L16 8Z"
                fill="white"
              />
            </svg>
          </div>
          <div class="brand-text">
            <h1>Tech For All</h1>
            <p>Inclusão Digital com Segurança</p>
          </div>
        </div>
        <div class="header-actions">
          <div class="role-badge">Professor</div>
          <button class="btn-secondary" onclick="logout()">Sair</button>
        </div>
      </div>
    </header>

    <main>
      <div class="card">
        <h2>Relatórios</h2>
        <p class="muted">Gere relatórios de turmas e alunos</p>

        <label for="turmaSelect">Selecione a turma</label>
        <select id="turmaSelect">
          <option value="">Carregando turmas...</option>
        </select>

        <button onclick="gerarRelatorio()">Gerar Relatório</button>
      </div>
    </main>

    <footer class="footer">
      <p>
        &copy; 2025 Tech For All - Inclusão Digital com Segurança | Protótipo
        Acadêmico
      </p>
    </footer>

    <script src="/common.js"></script>
    <script>
      const API_BASE = window.location.origin + "/api";

      function getSession() {
        return {
          user_id: localStorage.getItem("tf_user_id"),
          role: localStorage.getItem("tf_role"),
          name: localStorage.getItem("tf_name"),
        };
      }

      async function carregarTurmas() {
        const select = document.getElementById("turmaSelect");
        const s = getSession();

        try {
          const res = await fetch(`${API_BASE}/turmas`, {
            headers: {
              "X-User-Id": s.user_id,
              "X-User-Role": s.role,
            },
          });

          const data = await res.json();
          if (!data.success)
            throw new Error(data.message || "Erro ao listar turmas.");

          select.innerHTML = "";
          if (!data.turmas || data.turmas.length === 0) {
            select.innerHTML = `<option value="">Nenhuma turma cadastrada</option>`;
            return;
          }

          data.turmas.forEach((turma) => {
            const opt = document.createElement("option");
            opt.value = turma.id;
            opt.textContent = turma.nome;
            select.appendChild(opt);
          });
        } catch (err) {
          console.error("Erro ao carregar turmas:", err);
          select.innerHTML = `<option value="">Erro ao carregar turmas</option>`;
        }
      }

      async function gerarRelatorio() {
        const turmaId = document.getElementById("turmaSelect").value;
        if (!turmaId) {
          alert("Selecione uma turma primeiro.");
          return;
        }

        try {
          const res = await fetch(
            `${API_BASE}/relatorios/turma/${turmaId}/pdf`,
            {
              headers: {
                "X-User-Id": localStorage.getItem("tf_user_id"),
                "X-User-Role": localStorage.getItem("tf_role"),
              },
            }
          );
          const data = await res.json();

          if (data.success && data.url) {
            window.open(data.url, "_blank");
          } else {
            alert(
              data.message || "A geração de PDF ainda não está disponível."
            );
          }
        } catch (err) {
          console.error(err);
          alert("Erro ao gerar relatório.");
        }
      }

      document.addEventListener("DOMContentLoaded", carregarTurmas);
    </script>
  </body>
</html>
