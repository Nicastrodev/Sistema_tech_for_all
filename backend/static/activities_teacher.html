<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Atividades - Tech For All</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header class="header">
      <div class="header-container">
        <div class="brand">
          <div class="logo">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
              <path
                d="M16 2L28 9V23L16 30L4 23V9L16 2Z"
                fill="white"
                opacity="0.2"
              />
              <path
                d="M16 8L22 11.5V18.5L16 22L10 18.5V11.5L16 8Z"
                fill="white"
              />
            </svg>
          </div>
          <div class="brand-text">
            <h1>Tech For All</h1>
            <p>Inclusão Digital com Segurança</p>
          </div>
        </div>
        <div class="header-actions">
          <div class="role-badge">Professor</div>
          <button class="btn-secondary" onclick="logout()">Sair</button>
        </div>
      </div>
    </header>

    <main class="main-container">
      <section class="screen">
        <div class="form-container">
          <!-- CRIAR NOVA ATIVIDADE -->
          <div class="card">
            <div class="card-header">
              <h3>Gerenciar Atividades</h3>
              <p>Crie e publique novas atividades</p>
            </div>
            <form class="form" onsubmit="publishActivity(event)">
              <div class="form-group">
                <label for="actTitle">Título da atividade</label>
                <input
                  type="text"
                  id="actTitle"
                  placeholder="Ex: Exercício de Matemática 1"
                  required
                />
              </div>
              <div class="form-group">
                <label for="actDesc">Descrição</label>
                <textarea
                  id="actDesc"
                  rows="4"
                  placeholder="Descreva a atividade"
                ></textarea>
              </div>
              <div class="form-group">
                <label for="actDue">Prazo de entrega</label>
                <input type="date" id="actDue" required />
              </div>
              <div class="form-actions">
                <button type="submit" class="btn-primary">
                  Publicar Atividade
                </button>
                <button
                  type="button"
                  class="btn-outline"
                  onclick="window.location.href='dashboard_teacher.html'"
                >
                  Voltar
                </button>
              </div>
            </form>
          </div>

          <!-- ENTREGAS RECENTES -->
          <div class="card" style="margin-top: 24px">
            <div class="card-header">
              <h3>Entregas Recentes</h3>
            </div>
            <div id="submissionList" class="submission-list">
              <p>Carregando entregas...</p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <p>
        &copy; 2025 Tech For All - Inclusão Digital com Segurança | Protótipo
        Acadêmico
      </p>
    </footer>

    <script src="/common.js"></script>
    <script src="/script.js"></script>
    <script>
      const API_BASE = window.location.origin + "/api";

      function getSession() {
        return {
          user_id: localStorage.getItem("tf_user_id"),
          role: localStorage.getItem("tf_role"),
          name: localStorage.getItem("tf_name"),
        };
      }

      function notify(message, type = "info") {
        if (typeof showToast === "function") showToast(message, type);
        else alert(message);
      }

      // ===========================
      // PUBLICAR NOVA ATIVIDADE
      // ===========================
      async function publishActivity(event) {
        event.preventDefault();

        const session = getSession();
        if (!session.user_id || session.role !== "teacher") {
          return notify("Sessão inválida. Faça login novamente.", "error");
        }

        const title = document.getElementById("actTitle").value.trim();
        const desc = document.getElementById("actDesc").value.trim();
        const due = document.getElementById("actDue").value;

        if (!title || !due) {
          return notify("Preencha título e prazo antes de publicar.", "error");
        }

        const body = {
          titulo: title,
          descricao: desc,
          prazo: due,
          professor_id: session.user_id,
        };

        try {
          const res = await fetch(`${API_BASE}/tarefas`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-User-Id": session.user_id,
              "X-User-Role": session.role,
            },
            body: JSON.stringify(body),
          });

          const data = await res.json();
          if (!res.ok || !data.success)
            throw new Error(data.message || "Erro ao criar atividade.");

          notify(`Atividade "${title}" publicada com sucesso!`, "success");
          document.querySelector("form").reset();
          loadSubmissions();
        } catch (err) {
          console.error(err);
          notify("Erro ao publicar: " + err.message, "error");
        }
      }

      // ===========================
      // LISTAR ENTREGAS DOS ALUNOS
      // ===========================
      async function loadSubmissions() {
        const session = getSession();
        const container = document.getElementById("submissionList");

        if (!session.user_id || session.role !== "teacher") {
          container.innerHTML =
            "<p>Erro: sessão inválida. Faça login novamente.</p>";
          return;
        }

        try {
          const res = await fetch(
            `${API_BASE}/tarefas/entregas?userId=${session.user_id}&role=teacher`,
            {
              headers: {
                "X-User-Id": session.user_id,
                "X-User-Role": session.role,
              },
            }
          );
          const data = await res.json();

          if (!res.ok || !data.success) {
            throw new Error(data.message || "Falha ao carregar entregas.");
          }

          const entregas = data.entregas;
          if (!entregas || entregas.length === 0) {
            container.innerHTML =
              "<p>Nenhuma entrega de aluno foi recebida ainda.</p>";
            return;
          }

          container.innerHTML = "";
          entregas.forEach((entrega) => {
            const date = entrega.data_envio
              ? new Date(entrega.data_envio).toLocaleString("pt-BR")
              : "Data não registrada";

            const item = document.createElement("div");
            item.className = "submission-item";
            item.innerHTML = `
              <div class="submission-info">
                <h4>${entrega.aluno_nome}</h4>
                <p>${entrega.arquivo_nome} • Enviado em ${date}</p>
              </div>
              <div class="submission-actions">
                <button class="btn-outline-small"
                  onclick="downloadFile('${entrega.arquivo_url}')">
                  Baixar
                </button>
                <input type="number" id="nota-${entrega.id}" class="grade-input" min="0" max="10" step="0.1" placeholder="Nota" />
                <button class="btn-primary-small" onclick="sendGrade(${entrega.id})">Salvar Nota</button>
              </div>
            `;
            container.appendChild(item);
          });
        } catch (err) {
          console.error(err);
          container.innerHTML = `<p>Erro ao carregar entregas: ${err.message}</p>`;
        }
      }

      function downloadFile(url) {
        if (!url) return notify("Arquivo não disponível.", "error");
        window.open(url, "_blank");
      }

      // ===========================
      // ENVIAR NOTA PARA O BACKEND
      // ===========================
      async function sendGrade(respostaId) {
        const input = document.getElementById(`nota-${respostaId}`);
        const nota = parseFloat(input.value);
        const session = getSession();

        if (isNaN(nota) || nota < 0 || nota > 10) {
          return notify("Digite uma nota válida entre 0 e 10.", "error");
        }

        try {
          const res = await fetch(`${API_BASE}/tarefas/${respostaId}/avaliar`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-User-Id": session.user_id,
              "X-User-Role": session.role,
            },
            body: JSON.stringify({ nota }),
          });

          const data = await res.json();
          if (!res.ok || !data.success)
            throw new Error(data.message || "Erro ao salvar nota.");

          notify("Nota registrada com sucesso!", "success");
          input.value = "";
        } catch (err) {
          console.error(err);
          notify("Erro ao registrar nota: " + err.message, "error");
        }
      }

      document.addEventListener("DOMContentLoaded", loadSubmissions);
    </script>
  </body>
</html>